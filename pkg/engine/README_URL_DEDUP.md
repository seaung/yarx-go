# URL去重策略

本文档介绍了yarx-go爬虫系统中实现的几种URL去重策略，以及它们的优缺点和适用场景。

## 去重策略概述

系统提供了三种URL去重策略：

1. **数据库+内存缓存**：每次先检查内存缓存，缓存未命中时查询数据库
2. **布隆过滤器**：使用布隆过滤器快速判断URL是否可能存在，减少数据库查询
3. **Redis分布式缓存**：使用Redis进行分布式环境下的URL去重

## 策略详细说明

### 1. 数据库+内存缓存 (db)

**实现类**：`DBStorage`

**工作原理**：
- 维护一个内存中的URL缓存（map[string]bool）
- 处理URL时，先检查内存缓存
- 缓存未命中时，查询数据库
- 将查询结果添加到内存缓存中

**优点**：
- 实现简单
- 内存占用可控
- 100%准确（无误判）

**缺点**：
- 当URL数量大时，内存占用会增加
- 仍需查询数据库，有一定性能开销

**适用场景**：
- 中小规模爬虫任务
- URL总量在百万级以下
- 对准确性要求高的场景

### 2. 布隆过滤器 (bloom)

**实现类**：`BloomStorage`

**工作原理**：
- 使用布隆过滤器快速判断URL是否可能存在
- 布隆过滤器表示URL可能存在时，再查询确认缓存和数据库
- 布隆过滤器表示URL不存在时，直接添加（布隆过滤器不会有假阴性）

**优点**：
- 极高的空间效率，可处理大量URL
- 大幅减少数据库查询次数
- 查询速度快（O(k)复杂度，k为哈希函数数量）

**缺点**：
- 有一定误判率（假阳性），需要数据库二次确认
- 无法从过滤器中删除元素

**适用场景**：
- 大规模爬虫任务
- URL总量在千万级以上
- 对性能要求高的场景

### 3. Redis分布式缓存 (redis)

**实现类**：`RedisStorage`

**工作原理**：
- 使用Redis的SETNX命令实现分布式去重
- 可设置URL在Redis中的过期时间
- Redis操作失败时回退到数据库查询

**优点**：
- 支持分布式环境下的URL去重
- 可设置过期时间，自动清理旧URL
- 高可用性和可扩展性

**缺点**：
- 依赖Redis服务
- 网络通信开销

**适用场景**：
- 分布式爬虫系统
- 需要多个爬虫实例协同工作的场景
- 大规模、长时间运行的爬虫任务

## 使用方法

### 基本用法

默认情况下，系统使用布隆过滤器策略进行URL去重：

```go
// 使用默认配置（布隆过滤器）
err := engine.CrawlAndScan(targetURL, db)
```

### 自定义去重策略

可以通过`CrawlAndScanWithOptions`函数指定去重策略：

```go
// 创建自定义配置
options := &engine.CrawlOptions{
    CrawlerOpts: &engine.CrawlerOptions{
        Depth:       3,
        Concurrency: 10,
        // 其他爬虫选项...
    },
    StorageOpts: &engine.StorageOpts{
        // 选择存储类型: "db", "bloom", "redis"
        Type: "bloom",
        
        // 布隆过滤器配置
        BloomExpectedItems: 1000000,  // 预期处理100万URL
        BloomFalsePositive: 0.0001,   // 0.01%误判率
        
        // Redis配置（仅在Type="redis"时使用）
        RedisAddr:     "localhost:6379",
        RedisPassword: "",
        RedisDB:       0,
        RedisExpire:   24, // 24小时过期
    },
}

// 使用自定义配置爬取
err := engine.CrawlAndScanWithOptions(targetURL, db, options)
```

## 性能对比

以下是不同去重策略在不同URL规模下的性能对比（仅供参考）：

| 策略 | 10万URL | 100万URL | 1000万URL |
|------|---------|----------|----------|
| 数据库+内存缓存 | 良好 | 一般 | 较差 |
| 布隆过滤器 | 良好 | 良好 | 良好 |
| Redis分布式缓存 | 良好 | 良好 | 良好 |

## 内存占用对比

| 策略 | 10万URL | 100万URL | 1000万URL |
|------|---------|----------|----------|
| 数据库+内存缓存 | ~8MB | ~80MB | ~800MB |
| 布隆过滤器 | ~240KB | ~2.4MB | ~24MB |
| Redis分布式缓存 | 取决于Redis服务器配置 | 取决于Redis服务器配置 | 取决于Redis服务器配置 |

## 建议

1. 对于大多数场景，推荐使用**布隆过滤器**策略，它在性能和内存占用之间取得了很好的平衡
2. 对于分布式环境，推荐使用**Redis分布式缓存**策略
3. 对于小规模爬虫或对准确性要求极高的场景，可以使用**数据库+内存缓存**策略